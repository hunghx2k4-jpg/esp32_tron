<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Giám Sát Trạm Trộn</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #3498db; --secondary: #2ecc71; --danger: #e74c3c; --warning: #f39c12; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        /* Tank UI */
        .tank-area { display: flex; justify-content: space-around; margin: 30px 0; flex-wrap: wrap; }
        .tank-box { text-align: center; margin-bottom: 20px; }
        .tank { width: 100px; height: 200px; border: 4px solid var(--dark); position: relative; background: #eee; border-radius: 0 0 10px 10px; overflow: hidden; margin-bottom: 10px; }
        .water { position: absolute; bottom: 0; width: 100%; transition: height 1.5s ease-in-out; }
        
        /* Buttons */
        .btn-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-start { background: var(--danger); }
        .btn-excel { background: var(--secondary); }
        .btn-clear { background: var(--warning); }
        .btn:hover { opacity: 0.85; transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #fafafa; }
        .status { padding: 4px 10px; border-radius: 15px; background: #dff9fb; color: #130f40; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">GIÁM SÁT & ĐIỀU KHIỂN TRẠM TRỘN IOT</h2>
    
    <div class="tank-area">
        <div class="tank-box">
            <div class="tank"><div id="wA" class="water" style="height:0%; background: #3498db;"></div></div>
            <strong>Bể A: <span id="vA">0</span>%</strong>
        </div>
        <div class="tank-box">
            <div class="tank"><div id="wB" class="water" style="height:0%; background: #e67e22;"></div></div>
            <strong>Bể B: <span id="vB">0</span>%</strong>
        </div>
        <div class="tank-box">
            <div class="tank"><div id="wC" class="water" style="height:0%; background: #2ecc71;"></div></div>
            <strong>Bể Tổng: <span id="vC">0</span>%</strong>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-start" onclick="remoteMix()">KÍCH HOẠT TRỘN</button>
        <button class="btn btn-excel" onclick="exportData()">XUẤT EXCEL</button>
        <button class="btn btn-clear" onclick="clearHistory()">XÓA LỊCH SỬ</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ngày/Giờ</th>
                <th>Bình A (%)</th>
                <th>Bình B (%)</th>
                <th>Trạng thái</th>
            </tr>
        </thead>
        <tbody id="log-body">
            <tr><td colspan="4">Đang kết nối dữ liệu...</td></tr>
        </tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    // Cấu hình Firebase
    const config = { databaseURL: "https://test-2f3ed-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(config);
    const db = firebase.database();
    let excelData = [];

    // 1. Lấy mực nước Realtime
    db.ref('trang_thai_hien_tai').on('value', s => {
        const d = s.val(); if(!d) return;
        document.getElementById('wA').style.height = (d.levelA || 0) + '%'; 
        document.getElementById('vA').innerText = d.levelA || 0;
        document.getElementById('wB').style.height = (d.levelB || 0) + '%'; 
        document.getElementById('vB').innerText = d.levelB || 0;
        document.getElementById('wC').style.height = (d.levelC || 0) + '%'; 
        document.getElementById('vC').innerText = d.levelC || 0;
    });

    // 2. Lấy danh sách lịch sử và cập nhật bảng
    db.ref('lich_su_tron').on('value', s => {
        const logs = s.val(); const body = document.getElementById('log-body');
        body.innerHTML = ""; excelData = [];
        if(!logs) {
            body.innerHTML = "<tr><td colspan='4'>Chưa có dữ liệu lịch sử</td></tr>";
            return;
        }
        Object.keys(logs).reverse().forEach(k => {
            const row = logs[k];
            let d = new Date(row.thoi_gian * 1000);
            if(d.getFullYear() < 2024) d = new Date(); // Sửa lỗi thời gian ESP32
            const timeStr = d.toLocaleString('vi-VN');
            
            excelData.push({
                "Thời gian": timeStr, 
                "Bình A (%)": row.binh_A_percent, 
                "Bình B (%)": row.binh_B_percent,
                "Trạng thái": row.trang_thai
            });

            body.innerHTML += `<tr>
                <td>${timeStr}</td>
                <td>${row.binh_A_percent}%</td>
                <td>${row.binh_B_percent}%</td>
                <td><span class="status">${row.trang_thai}</span></td>
            </tr>`;
        });
    });

    // 3. Hàm kích hoạt trộn từ xa
    function remoteMix() {
        db.ref('dieu_khien').set({lenh_tron: 1});
        alert("Đã gửi lệnh kích hoạt đến ESP32!");
    }
    
    // 4. Hàm xuất Excel
    function exportData() {
        if(excelData.length === 0) return alert("Không có dữ liệu!");
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Lịch sử");
        XLSX.writeFile(wb, "Bao_cao_tron_dung_dich.xlsx");
    }

    // 5. Hàm XÓA LỊCH SỬ (Mới thêm)
    function clearHistory() {
        if(confirm("CẢNH BÁO: Bạn có chắc chắn muốn xóa toàn bộ dữ liệu lịch sử không? Hành động này không thể hoàn tác.")) {
            db.ref('lich_su_tron').remove()
            .then(() => alert("Đã xóa sạch lịch sử thành công!"))
            .catch(err => alert("Lỗi khi xóa: " + err));
        }
    }
</script>
</body>
</html>