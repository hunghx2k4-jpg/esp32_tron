<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>GIÁM SÁT & ĐIỀU KHIỂN TRẠM TRỘN IOT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --blue: #3498db; --orange: #e67e22; --green: #2ecc71; --red: #e74c3c; --yellow: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 900px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        h2 { color: #2c3e50; text-transform: uppercase; margin-bottom: 30px; letter-spacing: 1px; }
        
        /* Giao diện Bể nước */
        .tanks { display: flex; justify-content: space-around; margin-bottom: 40px; }
        .tank-item { width: 150px; }
        .tank-body { height: 220px; width: 110px; border: 3px solid #34495e; border-radius: 0 0 12px 12px; position: relative; margin: 0 auto 10px; background: #eee; overflow: hidden; }
        .water { position: absolute; bottom: 0; width: 100%; height: 0%; transition: height 1s ease-in-out; }
        .tank-label { font-weight: bold; color: #34495e; }

        /* Nút bấm */
        .controls { margin-bottom: 30px; display: flex; justify-content: center; gap: 15px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 13px; min-width: 150px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0.9; }
        .btn-excel { background: var(--green); }
        .btn-clear { background: var(--yellow); }

        /* Bảng */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--blue); color: white; padding: 12px; font-size: 14px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; color: #555; }
        .status { background: #e8f6f3; color: #16a085; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>GIÁM SÁT & ĐIỀU KHIỂN TRẠM TRỘN IOT</h2>

    <div class="tanks">
        <div class="tank-item">
            <div class="tank-body"><div id="wA" class="water" style="background: var(--blue);"></div></div>
            <div class="tank-label">Bể A: <span id="tA">0</span>%</div>
        </div>
        <div class="tank-item">
            <div class="tank-body"><div id="wB" class="water" style="background: var(--orange);"></div></div>
            <div class="tank-label">Bể B: <span id="tB">0</span>%</div>
        </div>
        <div class="tank-item">
            <div class="tank-body"><div id="wC" class="water" style="background: var(--green);"></div></div>
            <div class="tank-label">Bể Tổng: <span id="tC">0</span>%</div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-excel" onclick="exportExcel()">XUẤT BÁO CÁO EXCEL</button>
        <button class="btn btn-clear" onclick="clearData()">XÓA LỊCH SỬ TRỘN</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ngày/Giờ</th>
                <th>Bình A (%)</th>
                <th>Bình B (%)</th>
                <th>Trạng thái</th>
            </tr>
        </thead>
        <tbody id="history"></tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://test-2f3ed-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let logs = [];

    // 1. Lấy dữ liệu mực nước realtime
    db.ref('trang_thai_hien_tai').on('value', s => {
        const d = s.val() || {levelA:0, levelB:0, levelC:0};
        document.getElementById('wA').style.height = d.levelA + '%'; document.getElementById('tA').innerText = d.levelA;
        document.getElementById('wB').style.height = d.levelB + '%'; document.getElementById('tB').innerText = d.levelB;
        document.getElementById('wC').style.height = d.levelC + '%'; document.getElementById('tC').innerText = d.levelC;
    });

    // 2. Lấy lịch sử và xử lý thời gian
    db.ref('lich_su_tron').on('value', s => {
        const data = s.val();
        const tbody = document.getElementById('history');
        tbody.innerHTML = "";
        logs = [];
        if(!data) return;

        Object.keys(data).reverse().forEach(id => {
            const item = data[id];
            let timeDisplay = "";

            if (typeof item.thoi_gian === 'string' && item.thoi_gian.includes('/')) {
                timeDisplay = item.thoi_gian;
            } else if (typeof item.thoi_gian === 'number' || !isNaN(item.thoi_gian)) {
                const d = new Date(item.thoi_gian * 1000);
                timeDisplay = d.toLocaleString('vi-VN');
            } else {
                timeDisplay = "Không rõ thời gian";
            }

            if (timeDisplay.includes("1970")) timeDisplay = "Lỗi đồng bộ mạch";

            logs.push({ "Thời gian": timeDisplay, "A": item.binh_A_percent, "B": item.binh_B_percent });
            tbody.innerHTML += `<tr><td>${timeDisplay}</td><td>${item.binh_A_percent}%</td><td>${item.binh_B_percent}%</td><td><span class="status">Hoàn thành</span></td></tr>`;
        });
    });

    function clearData() { if(confirm("Bạn có chắc chắn muốn xóa toàn bộ lịch sử trộn không?")) db.ref('lich_su_tron').remove(); }
    
    function exportExcel() {
        if (logs.length === 0) {
            alert("Không có dữ liệu để xuất!");
            return;
        }
        const ws = XLSX.utils.json_to_sheet(logs);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Lịch sử");
        XLSX.writeFile(wb, "Bao_cao_tram_tron.xlsx");
    }
</script>
</body>
</html>
